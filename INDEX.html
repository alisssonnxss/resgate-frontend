<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SISTEMA DE RESGATE DE C√ìDIGO √öNICO</title>
    <style>
        :root {
            /* Cores Dark Mode (Padr√£o) */
            --cor-primaria: #00BFFF; /* Azul Claro Vibrante */
            --cor-secundaria: #008DBC; /* Azul Mais Escuro */
            --cor-fundo: #121212; /* Fundo Escuro S√≥lido */
            --cor-card-fundo: #1E1E1E; /* Card Escuro */
            --cor-texto-principal: #F0F0F0;
            --cor-texto-secundario: #A0A0A0;
            --cor-aviso-erro: #FF5252;
            --cor-verde: #00E676;
            --cor-amarelo-pendente: #FFD700;
            --cor-borda: #333333;
            --cor-input-fundo: #2A2A2A; 
            --cor-hr: #3A3A3A;
            --cor-hover-item: #252525;
            
            --cor-btn-principal: var(--cor-primaria);
            --cor-btn-reabrir: var(--cor-verde);
            --cor-btn-deletar: #D50000;
            --cor-btn-testar: #FFA500; /* Laranja para Teste */
            
            --border-radius-main: 12px;
            --border-radius-small: 6px;

            /* Cores de Status para Hist√≥rico */
            --status-pendente-cor: var(--cor-amarelo-pendente);
            --status-concluido-cor: var(--cor-verde);
            --status-antigo-cor: var(--cor-primaria); /* Novo status: Resgate Antigo */
            
            /* Nova Cor para Bot√£o de Suporte/WhatsApp */
            --cor-btn-whatsapp: #25D366; 
        }

        body.light-mode {
            /* Cores Light Mode */
            --cor-primaria: #1E90FF;
            --cor-secundaria: #1C86EE;
            --cor-fundo: #F0F2F5; 
            --cor-card-fundo: #FFFFFF; 
            --cor-texto-principal: #333333; 
            --cor-texto-secundario: #666666;
            --cor-aviso-erro: #D32F2F; 
            --cor-verde: #388E3C; 
            --cor-amarelo-pendente: #FFC107;
            --cor-borda: #DDDDDD;
            --cor-input-fundo: #F8F8F8; 
            --cor-hr: #EEEEEE;
            --cor-hover-item: #F5F5F5;
            
            --cor-btn-deletar: #D32F2F;
            --cor-btn-testar: #FF8C00; 

            /* Cores de Status para Hist√≥rico Light */
            --status-pendente-cor: #FFB300;
            --status-concluido-cor: #4CAF50;
            --status-antigo-cor: var(--cor-primaria);
            
            /* Nova Cor para Bot√£o de Suporte/WhatsApp Light */
            --cor-btn-whatsapp: #4CAF50; 
        }

        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
            background-color: var(--cor-fundo);
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px 10px;
            color: var(--cor-texto-principal);
            transition: background-color 0.2s, color 0.2s;
            overflow-x: hidden;
        }

        /* ----------------------------------- */
        /* TELA DE LOGIN (OVERLAY) */
        /* ----------------------------------- */
        .login-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--cor-fundo); 
            z-index: 10000; 
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            transition: opacity 0.5s, visibility 0.5s;
        }
        .login-box {
            background-color: var(--cor-card-fundo);
            padding: 30px;
            border-radius: var(--border-radius-main);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
            max-width: 350px;
            width: 90%;
            text-align: center;
            border: 1px solid var(--cor-borda);
        }
        .login-box h2 {
            color: var(--cor-primaria);
            margin-bottom: 20px;
            font-size: 1.4em;
        }
        .login-box input {
            margin-bottom: 15px;
        }
        
        .login-box button {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: var(--border-radius-small);
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            letter-spacing: 0.5px;
            transition: background-color 0.2s, transform 0.1s, box-shadow 0.2s;
            color: white;
            background-color: var(--cor-primaria); 
            box-shadow: 0 5px 20px rgba(0, 191, 255, 0.5); 
        }
        .login-box button:hover {
            background-color: var(--cor-secundaria);
            box-shadow: 0 8px 25px rgba(0, 191, 255, 0.7);
            transform: translateY(-3px); 
        }

        /* ----------------------------------- */
        /* BOT√ïES DE TOPO (SUPORTE) */
        /* ----------------------------------- */
        .top-button {
            position: fixed;
            top: 20px;
            right: 20px; /* Alinhado √† direita */
            z-index: 1000;
            padding: 10px 15px;
            border-radius: var(--border-radius-main);
            font-size: 0.9em;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
            cursor: pointer;
        }
        
        .top-support-btn {
            background-color: var(--cor-btn-whatsapp);
            color: white;
            box-shadow: 0 4px 15px rgba(37, 211, 102, 0.5);
            text-decoration: none; 
        }
        .top-support-btn:hover {
            background-color: #128C7E;
            box-shadow: 0 6px 20px rgba(37, 211, 102, 0.7);
            transform: translateY(-2px);
        }

        /* Oculta na tela de login, aparece ap√≥s o login */
        body:not(.logged-in) .top-button {
            display: none; 
        }

        #msgLogin {
            color: var(--cor-aviso-erro);
            font-weight: bold;
            margin-top: 10px;
            display: none;
        }
        
        .content-hidden {
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.5s;
        }
        
        body.logged-in .content-hidden {
            opacity: 1;
            visibility: visible;
        }

        /* --- SIDEBAR --- */
        #menu-toggle-btn {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1000;
            font-size: 24px;
            color: var(--cor-texto-principal);
            background: var(--cor-card-fundo);
            border: 1px solid var(--cor-borda);
            padding: 5px 10px;
            border-radius: var(--border-radius-small);
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        #menu-toggle-btn:hover {
             color: var(--cor-primaria);
             border-color: var(--cor-primaria);
             transform: scale(1.05);
        }

        body:not(.logged-in) #menu-toggle-btn {
             display: none;
        }

        .sidebar {
            height: 100%;
            width: 0; 
            position: fixed;
            z-index: 9999; 
            top: 0;
            left: 0;
            background-color: var(--cor-card-fundo);
            overflow-x: hidden;
            transition: 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94); 
            padding-top: 60px;
            box-shadow: 4px 0 20px rgba(0,0,0,0.6);
            border-right: 3px solid var(--cor-primaria);
            display: flex; 
            flex-direction: column;
        }
        
        .sidebar-nav-main {
            flex-grow: 1; 
        }
        
        .sidebar-item {
            padding: 15px 25px;
            text-decoration: none;
            font-size: 1.1em;
            color: var(--cor-texto-principal);
            display: flex; 
            align-items: center;
            gap: 10px;
            transition: 0.2s background-color, 0.2s color, 0.2s padding-left;
            cursor: pointer;
            font-weight: 600;
            border-bottom: 1px solid var(--cor-hr);
        }

        .sidebar-item:hover {
            background-color: var(--cor-hover-item);
            color: var(--cor-primaria);
            padding-left: 30px; 
        }
        .sidebar-item.active {
             background-color: var(--cor-hover-item);
             color: var(--cor-primaria);
             border-left: 5px solid var(--cor-primaria);
        }
        
        .sidebar .closebtn {
            position: absolute;
            top: 0;
            right: 25px;
            font-size: 36px;
            margin-left: 50px;
            text-decoration: none;
            color: var(--cor-texto-secundario);
            transition: color 0.15s;
        }
        .sidebar .closebtn:hover {
             color: var(--cor-aviso-erro);
        }
        
        .sidebar-item-theme {
            font-weight: bold;
            color: var(--status-pendente-cor); 
            border-top: 1px solid var(--cor-hr);
            border-bottom: none;
            margin-bottom: 10px;
        }

        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            height: 100%;
            width: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 998;
            display: none;
        }

        .container {
            background-color: var(--cor-card-fundo); 
            padding: 25px;
            border-radius: var(--border-radius-main);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2); 
            width: 100%;
            max-width: 450px;
            border: 1px solid var(--cor-borda);
            position: relative;
            margin-bottom: 30px; 
            transition: background-color 0.2s, box-shadow 0.2s;
            margin-top: 50px;
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 3px solid var(--cor-primaria);
        }

        h1 {
            color: var(--cor-texto-principal);
            text-align: center;
            margin: 0;
            font-size: 1.6em;
            letter-spacing: 1px;
            text-transform: uppercase;
            font-weight: 700;
        }
        
        .tab-content { display: none; padding-top: 10px; }
        .tab-content.active { display: block; }

        textarea, input[type="text"], input[type="search"] {
            width: 100%;
            padding: 12px;
            margin-bottom: 20px;
            border: 1px solid var(--cor-borda);
            background-color: var(--cor-input-fundo);
            color: var(--cor-texto-principal);
            border-radius: var(--border-radius-small);
            box-sizing: border-box;
            font-size: 0.95em;
            transition: border-color 0.2s, background-color 0.2s, box-shadow 0.2s;
        }
        
        .container button:not(.delete-button, .status-button) {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: var(--border-radius-small);
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            letter-spacing: 0.5px;
            transition: background-color 0.2s, transform 0.1s, box-shadow 0.2s;
            color: white;
            background-color: var(--cor-btn-principal);
            box-shadow: 0 4px 15px rgba(0, 191, 255, 0.3);
        }
        
        .container button:hover:not(.delete-button, .status-button) {
            background-color: var(--cor-secundaria);
            box-shadow: 0 6px 18px rgba(0, 191, 255, 0.4);
            transform: translateY(-2px);
        }

        .reopen-button {
            background-color: var(--cor-btn-reabrir) !important;
            box-shadow: 0 4px 15px rgba(0, 230, 118, 0.3);
            transition: background-color 0.2s, transform 0.1s, box-shadow 0.2s;
        }
        .reopen-button:hover {
            background-color: #00CC66 !important;
            box-shadow: 0 6px 18px rgba(0, 230, 118, 0.4);
            transform: translateY(-2px);
        }

        .test-button { 
            background-color: var(--cor-btn-testar) !important;
            box-shadow: 0 4px 15px rgba(255, 165, 0, 0.3);
        }
        .test-button:hover {
            background-color: #FF8C00 !important;
            box-shadow: 0 6px 18px rgba(255, 165, 0, 0.4);
        }
        
        /* --- GUIA DE ERROS (MANTIDOS) --- */
        .guide-container {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid var(--cor-hr);
        }
        .guide-container h3 {
             font-size: 1.1em;
             color: var(--cor-primaria);
             margin-bottom: 15px;
        }

        .guide-step {
            background-color: var(--cor-input-fundo);
            padding: 15px;
            border-radius: var(--border-radius-small);
            border: 1px solid var(--cor-borda);
            margin-bottom: 15px;
        }

        .guide-step p {
            font-weight: bold;
            font-size: 1em;
            margin-bottom: 5px;
        }
        
        .guide-step .error-status {
            font-size: 0.9em;
            font-weight: 700;
            display: inline-block;
            padding: 4px 8px;
            border-radius: var(--border-radius-small);
            margin-top: 8px;
        }

        .guide-step .error-message {
            background-color: var(--cor-card-fundo);
            border: 1px dashed var(--cor-texto-secundario);
            padding: 10px;
            font-family: 'Courier New', monospace;
            font-size: 0.8em;
            white-space: pre-wrap;
            word-break: break-all;
            margin-top: 10px;
            color: var(--cor-texto-secundario);
        }

        .status-funcionando {
            color: var(--cor-verde);
            border: 1px solid var(--cor-verde);
            background-color: rgba(0, 230, 118, 0.1);
        }
        
        .status-vencido {
            color: var(--cor-aviso-erro);
            border: 1px solid var(--cor-aviso-erro);
            background-color: rgba(255, 82, 82, 0.1);
        }
        
        /* --- ESTILOS DE HIST√ìRICO (REATIVADOS) --- */
        .historico-lista {
            list-style: none;
            padding: 0;
            margin: 15px 0 30px 0;
            min-height: 50px; 
        }
        .historico-titulo {
            border-bottom: 2px solid var(--cor-hr);
            padding-bottom: 8px;
            margin-top: 20px;
            color: var(--cor-texto-principal);
            font-size: 1.2em;
        }
        .historico-item-wrapper {
            display: flex;
            align-items: center;
            background-color: var(--cor-input-fundo); 
            border-radius: var(--border-radius-small);
            margin-bottom: 10px;
            padding: 8px 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            position: relative;
            transition: all 0.2s;
            cursor: pointer;
        }
        .historico-item-wrapper:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        
        /* Cores de borda baseadas no tipo de resgate */
        .historico-item-wrapper[data-type="GERAR"] {
            border-left: 4px solid var(--status-concluido-cor);
        }
        .historico-item-wrapper[data-type="ANTECIPAR"] {
            border-left: 4px solid var(--status-pendente-cor);
        }
        .historico-item-wrapper[data-type="ANTIGO"] {
            border-left: 4px solid var(--status-antigo-cor);
        }

        .historico-item {
            flex-grow: 1;
            padding: 5px;
            background-color: transparent;
        }

        .item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }
        .item-nome {
            font-weight: 700;
            color: var(--cor-primaria); /* Nickname em destaque */
            font-size: 1.1em;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            max-width: 60%;
        }
        .item-data {
            font-size: 0.75em;
            color: var(--cor-texto-secundario);
            font-style: italic;
        }
        .item-info-row {
            display: flex;
            gap: 15px;
            font-size: 0.85em;
            color: var(--cor-texto-secundario);
            margin-top: 4px;
        }
        .item-info-row span {
            font-weight: 500;
        }
        
        .status-tag {
            font-size: 0.75em;
            font-weight: 600;
            padding: 3px 6px;
            border-radius: 4px;
            color: #121212; /* Cor de texto padr√£o para tags */
            margin-left: 10px;
            background-color: var(--cor-borda);
        }
        .historico-item-wrapper[data-type="GERAR"] .status-tag {
            background-color: var(--cor-verde);
        }
        .historico-item-wrapper[data-type="ANTECIPAR"] .status-tag {
            background-color: var(--cor-amarelo-pendente);
        }
        .historico-item-wrapper[data-type="ANTIGO"] .status-tag {
            background-color: var(--cor-primaria);
        }
        
        .delete-button {
            background-color: transparent;
            color: var(--cor-btn-deletar);
            border: none;
            width: 30px;
            height: 30px;
            line-height: 1;
            font-size: 1.2em; 
            font-weight: bold;
            cursor: pointer;
            flex-shrink: 0;
            transition: all 0.15s; 
            border-radius: 50%;
        }
        .delete-button:hover {
            background-color: rgba(213, 0, 0, 0.1); 
            color: #FF1744; 
            transform: scale(1.1);
        }

    </style>
</head>
<body>
    
    <a href="https://wa.me/SEUNUMERODOWHATSAPP" target="_blank" class="top-button top-support-btn" title="Fale com nosso Suporte">
        üí¨ Suporte
    </a>

    <div id="loginOverlay" class="login-overlay">
        <div class="login-box">
            <h2>ACESSO AO SISTEMA DE RESGATE</h2>
            <p style="color: var(--cor-texto-secundario); margin-bottom: 20px;">Insira o c√≥digo de acesso √∫nico.</p>
            
            <input type="text" id="inputCodigoUnico" placeholder="Digite seu c√≥digo aqui..." autocomplete="off" maxlength="15">

            <button onclick="fazerLogin()">ACESSAR SISTEMA</button>

            <p id="msgLogin">C√≥digo inv√°lido, j√° usado ou expirado.</p>
        </div>
    </div>

    <button id="menu-toggle-btn" class="content-hidden" onclick="openSidebar()">‚ò∞</button>

    <div class="overlay" onclick="closeSidebar()"></div>

    <div id="mySidebar" class="sidebar">
        <a href="javascript:void(0)" class="closebtn" onclick="closeSidebar()">&times;</a>
        
        <div class="sidebar-nav-main">
            <a class="sidebar-item" id="nav-gerar" onclick="changeTab('gerar')">üöÄ Iniciar Novo Resgate</a>
            <a class="sidebar-item" id="nav-antecipar" onclick="changeTab('antecipar')">üíæ Salvar Link Pendente</a>
            <a class="sidebar-item" id="nav-resgateAntigo" onclick="changeTab('resgateAntigo')">üîë Resgate Acesso Antigo</a>
            <a class="sidebar-item" id="nav-testar" onclick="changeTab('testar')">üõ†Ô∏è Testar C√≥digo</a> 
            <a class="sidebar-item" id="nav-historico" onclick="changeTab('historico')">üìã Hist√≥rico de Resgates</a>
        </div>
        
        <a class="sidebar-item sidebar-item-theme" id="nav-theme" onclick="toggleTheme(); closeSidebar();">
            <span id="sidebar-theme-text">‚òÄÔ∏è Mudar para Modo Claro</span>
        </a>
    </div>

    <div class="container content-hidden">
        <div class="header-content">
            <h1>SISTEMA DE RESGATE DE C√ìDIGO √öNICO</h1>
        </div>

        <div id="gerar" class="tab-content active">
            <label for="linkOriginal">Cole o Link de Origem (Ex: help.garena.com?ref=...)</label>
            <textarea id="linkOriginal" placeholder="Cole o link de origem completo aqui..."></textarea>

            <button onclick="gerarLink()">Gerar e Abrir Link</button>

            <hr style="margin: 30px 0; border: 0; border-top: 1px solid var(--cor-hr);">

            <label for="linkResultado">Link de Resgate Gerado:</label>
            <input type="text" id="linkResultado" value="Aguardando..." readonly>

            <button class="reopen-button" onclick="reabrirLink()" id="btnReabrir" disabled style="margin-top: 10px;">
                ‚û°Ô∏è Reabrir Link Atual
            </button>
            
            <p class="aviso" id="avisoErroGerar" style="display:none; color: var(--cor-aviso-erro); margin-top: 10px;">
                üö® Por favor, cole um link v√°lido que contenha '?' (ponto de interroga√ß√£o).
            </p>
        </div>
        
        <div id="antecipar" class="tab-content">
            <label for="linkAntecipar">Cole o Link para Salvar como Pendente:</label>
            <textarea id="linkAntecipar" placeholder="Cole o link completo aqui. Ele ser√° salvo para resgatar depois."></textarea>

            <button onclick="salvarAntecipar()">Salvar como Pendente</button>

            <p class="aviso" id="avisoErroAntecipar" style="display:none; color: var(--cor-aviso-erro); margin-top: 10px;">
                üö® Por favor, cole um link v√°lido que contenha '?' (ponto de interroga√ß√£o).
            </p>
        </div>

        <div id="resgateAntigo" class="tab-content">
            <label for="linkAccessAntigo">Cole o Access Token/URL Inteira (Ex: access_token=...) </label>
            <textarea id="linkAccessAntigo" placeholder="Cole o access token completo ou a URL inteira aqui..."></textarea>

            <button onclick="resgateAntigo()">Resgatar com M√©todo Antigo</button>

            <p class="aviso" id="avisoErroAntigo" style="display:none; color: var(--cor-aviso-erro); margin-top: 10px;">
                üö® Por favor, cole um token v√°lido que contenha 'access_token=' ou '?'.
            </p>
        </div>
        
        <div id="testar" class="tab-content">
            <h3 class="historico-titulo" style="margin-top: 0; border-bottom: 1px solid var(--cor-hr);">Verifica√ß√£o R√°pida de C√≥digo</h3>
            
            <p style="color: var(--cor-texto-secundario); margin-bottom: 20px; text-align: center;">
                Clique no bot√£o abaixo para abrir o link de teste e verificar o status do c√≥digo atrav√©s da mensagem de erro da Garena.
            </p>

            <button class="test-button" onclick="testarCodigo()">
                üîç TESTAR C√ìDIGO
            </button>
            
            <div class="guide-container">
                <h3>üìö Guia R√°pido: Como o C√≥digo est√°?</h3>
                
                <div class="guide-step">
                    <p>STATUS:</p>
                    <span class="error-status status-funcionando">üü¢ C√ìDIGO FUNCIONANDO</span>
                    
                    <p style="margin-top: 10px; font-weight: normal; color: var(--cor-texto-principal);">
                        Quando o c√≥digo **est√° funcionando** (v√°lido, mas em regi√£o errada), a tela de resgate exibir√°:
                    </p>
                    <div class="error-message">
                        ERROR
Failed to redeem
The code can't be used in your region. Please check again or contact the customer service.
                    </div>
                </div>
                
                <div class="guide-step">
                    <p>STATUS:</p>
                    <span class="error-status status-vencido">üî¥ C√ìDIGO VENCIDO OU EXPIRADO</span>
                    
                    <p style="margin-top: 10px; font-weight: normal; color: var(--cor-texto-principal);">
                        Quando o c√≥digo **est√° vencido/resgatado**, a tela de resgate exibir√°:
                    </p>
                    <div class="error-message">
                        ERROR
Failed to redeem
Failed to redeem. This code is invalid or redeemed.
                    </div>
                </div>
            </div>
            
        </div>
        
        <div id="historico" class="tab-content">
            <label for="searchHistorico">Pesquisar no Hist√≥rico (Em Breve):</label>
            <input type="search" id="searchHistorico" placeholder="Digite um nome ou data para buscar..." disabled>
            
            <h3 class="historico-titulo">Hist√≥rico de Resgates</h3>

            <ul id="historicoLista" class="historico-lista">
                </ul>
        </div>
        
    </div>
    
    <div class="footer content-hidden">
        Sistema de Resgate de C√≥digo √önico
    </div>

    <script>
        // CR√çTICO: COLOQUE A URL DO SEU BACKEND AQUI AP√ìS O DEPLOY NO RENDER!
        const BACKEND_URL = "https://resgate-api-node.onrender.com"; 

        // ‚ö†Ô∏è IMPORTANTE: SUBSTITUA ESTE N√öMERO PELO SEU TELEFONE DE SUPORTE NO WHATSAPP (COM C√ìDIGO DO PA√çS E DDD)
        const WHATSAPP_NUMBER = "553196373580"; 

        const LINK_BASE_NOVO = "https://reward.ff.garena.com/en?";
        const LINK_BASE_ANTIGO = "https://reward.ff.garena.com/";
        
        // Link de Teste de C√≥digo Fixo (ATUALIZADO COM O '$' CONFORME REQUISI√á√ÉO)
        const LINK_TESTE_FIXO = "https://reward.ff.garena.com/en?access_token=96156fe920a2edda35b7b3e80503b81c19af947d632ef3e498ddf8622bfb8586&game=FF&lang=en&region=EUROPE&account_id=11264235286&nickname=teste80c$";

        const STORAGE_KEY = 'resgateHistory';
        const THEME_KEY = 'siteTheme';
        const TOKEN_KEY = 'sessionTokenUnique'; 

        // --- FUN√á√ïES DE UTILIDADE ---
        
        /**
         * Tenta extrair ID, Nickname e o link base de uma URL.
         * Decodifica o Nickname.
         * @param {string} url - O link completo (token, ref, etc.).
         * @returns {{id: string, nickname: string, link: string}}
         */
        function extrairDadosDoLink(url) {
            const params = new URLSearchParams(url.substring(url.indexOf('?') + 1));
            let nickname = params.get('nickname') || 'N/D';
            const account_id = params.get('account_id') || 'N/D';
            
            // 1. Tenta decodificar o Nickname
            if (nickname && nickname !== 'N/D') {
                try {
                    // Decodifica a URL (resolve %E3%85%A4) e remove o caractere '$' se estiver no final
                    nickname = decodeURIComponent(nickname).replace(/\$$/, '').trim(); 
                } catch (e) {
                    console.error("Erro ao decodificar Nickname:", e);
                    // Se falhar, usa o valor original.
                }
            }
            
            // 2. Tenta encontrar a parte principal do link (at√© o primeiro '&') ou exibe o in√≠cio
            let linkCurto = url.substring(0, url.indexOf('?') + 1);
            const tokenParam = params.get('access_token');
            
            if (tokenParam) {
                linkCurto += 'access_token=' + tokenParam.substring(0, 15) + '...';
            } else {
                 linkCurto = url.substring(0, 45) + '...'; // Pega o in√≠cio da URL se n√£o tiver token
            }

            return {
                id: account_id,
                nickname: nickname,
                linkCurto: linkCurto,
                linkCompleto: url
            };
        }

        function getCurrentDateTime() {
            const now = new Date();
            const date = now.toLocaleDateString('pt-BR');
            const time = now.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
            return `${date} - ${time}`;
        }


        // --- FUN√á√ïES DE LOGIN (INTEGRA√á√ÉO COM O BACKEND) ---
        
        function liberarAcessoTotal() {
            document.body.classList.add('logged-in');
            document.getElementById('loginOverlay').style.display = 'none';
            
            // Configura o link do WhatsApp
            document.querySelectorAll('.top-support-btn').forEach(a => {
                a.href = `https://wa.me/${WHATSAPP_NUMBER}?text=Ol√°!%20Preciso%20de%20suporte%20com%20o%20sistema%20de%20resgate.`;
            });

            loadHistory();
            
            changeTab('gerar'); 
        }

        async function fazerLogin() {
            const input = document.getElementById('inputCodigoUnico');
            const msg = document.getElementById('msgLogin');
            const codigoDigitado = input.value.trim();
            
            msg.style.display = 'none';

            if (!codigoDigitado) {
                msg.innerText = "‚ùå Digite o c√≥digo de acesso.";
                msg.style.display = 'block';
                return;
            }

            try {
                // Envia o c√≥digo para o Backend (Render)
                const response = await fetch(`${BACKEND_URL}/api/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code: codigoDigitado })
                });

                const data = await response.json();

                if (response.ok) {
                    localStorage.setItem(TOKEN_KEY, data.sessionToken); 
                    liberarAcessoTotal();
                } else {
                    msg.innerText = data.message || 'Erro de login. Tente novamente.';
                    msg.style.display = 'block';
                }
            } catch (error) {
                console.error('Erro de conex√£o com o Backend:', error);
                msg.innerText = '‚ùå Erro de conex√£o. Servidor indispon√≠vel ou URL errada.';
                msg.style.display = 'block';
            }
        }
        
        function checkLoginStatus() {
            const token = localStorage.getItem(TOKEN_KEY);
            
            if (token) {
                liberarAcessoTotal();
            } else {
                document.getElementById('loginOverlay').style.display = 'flex';
            }
        }

        // --- FUN√á√ïES DE SIDEBAR E NAVEGA√á√ÉO ---
        function openSidebar() {
            document.getElementById("mySidebar").style.width = "250px";
            document.querySelector(".overlay").style.display = "block";
            document.body.classList.add('sidebar-open'); 
        }

        function closeSidebar() {
            document.getElementById("mySidebar").style.width = "0";
            document.querySelector(".overlay").style.display = "none";
            document.body.classList.remove('sidebar-open'); 
        }
        
        function changeTab(tabName) {
            closeSidebar(); 
            
            let tabcontent = document.getElementsByClassName("tab-content");
            for (let i = 0; i < tabcontent.length; i++) {
                tabcontent[i].classList.remove("active");
            }
            
            document.getElementById(tabName).classList.add("active");
            
            document.querySelectorAll('.sidebar-item').forEach(item => item.classList.remove('active'));
            document.getElementById(`nav-${tabName}`).classList.add('active');

            if (tabName === 'historico') {
                renderHistory();
            }
        }
        
        // --- FUN√á√ïES DE TEMA ---
        function applyTheme(isLight) {
            const body = document.body;
            const toggleSidebar = document.getElementById('sidebar-theme-text');
            
            if (isLight) {
                body.classList.add('light-mode');
                toggleSidebar.innerHTML = 'üåô Mudar para Modo Escuro';
                localStorage.setItem(THEME_KEY, 'light');
            } else {
                body.classList.remove('light-mode');
                toggleSidebar.innerHTML = '‚òÄÔ∏è Mudar para Modo Claro';
                localStorage.setItem(THEME_KEY, 'dark');
            }
        }
        function toggleTheme() {
            const isLight = document.body.classList.contains('light-mode');
            applyTheme(!isLight);
        }
        function loadTheme() {
            const savedTheme = localStorage.getItem(THEME_KEY) || 'dark';
            applyTheme(savedTheme === 'light');
        }
        
        // --- FUN√á√ïES DE HIST√ìRICO ---
        function getHistory() {
            const historyJson = localStorage.getItem(STORAGE_KEY);
            return historyJson ? JSON.parse(historyJson) : [];
        }

        function saveHistory(item) {
            const history = getHistory();
            history.unshift(item); 
            localStorage.setItem(STORAGE_KEY, JSON.stringify(history));
            renderHistory();
        }

        function deleteHistoryItem(index) {
            if (confirm("Tem certeza que deseja apagar este item do hist√≥rico?")) {
                const history = getHistory();
                history.splice(index, 1);
                localStorage.setItem(STORAGE_KEY, JSON.stringify(history));
                renderHistory();
            }
        }

        function renderHistory() {
            const list = document.getElementById('historicoLista');
            const history = getHistory();
            list.innerHTML = ''; 
            
            if (history.length === 0) {
                list.innerHTML = `<p style="color: var(--cor-texto-secundario); text-align: center; margin-top: 30px;">
                    Nenhum resgate salvo ainda.
                </p>`;
                return;
            }

            history.forEach((item, index) => {
                const li = document.createElement('li');
                li.className = 'historico-item-wrapper';
                li.setAttribute('data-type', item.type);
                li.onclick = () => {
                    window.open(item.linkCompleto, '_blank');
                };

                const typeText = item.type === 'GERAR' ? 'Gerado' : (item.type === 'ANTECIPAR' ? 'Pendente' : 'Antigo');

                li.innerHTML = `
                    <div class="historico-item">
                        <div class="item-header">
                            <span class="item-nome" title="${item.nickname}">${item.nickname}</span>
                            <span class="status-tag">${typeText}</span>
                        </div>
                        <div class="item-info-row">
                            <span>ID: <strong>${item.id}</strong></span>
                            <span>Data: ${item.date}</span>
                        </div>
                    </div>
                    <button class="delete-button" title="Apagar Item" onclick="event.stopPropagation(); deleteHistoryItem(${index})">
                        &times;
                    </button>
                `;
                list.appendChild(li);
            });
        }

        function loadHistory() {
             console.log("Hist√≥rico reativado e pronto para uso.");
        }
        
        // --- GERA√á√ÉO E OUTROS ---
        
        function validarLink(link, avisoId, deveConter = '?') {
            const avisoErro = document.getElementById(avisoId);
            const isValid = link.includes(deveConter);
            
            if (!isValid) {
                avisoErro.style.display = 'block';
                return false; 
            }

            avisoErro.style.display = 'none';
            return true;
        }

        function gerarLink() {
            const linkOriginal = document.getElementById('linkOriginal').value.trim();
            const linkResultadoInput = document.getElementById('linkResultado');
            const btnReabrir = document.getElementById('btnReabrir');
            
            btnReabrir.disabled = true;
            linkResultadoInput.value = "Aguardando...";

            if (!validarLink(linkOriginal, 'avisoErroGerar', '?')) return;

            const stringDeConsulta = linkOriginal.substring(linkOriginal.indexOf('?') + 1);
            const novoLink = LINK_BASE_NOVO + stringDeConsulta;
            
            linkResultadoInput.value = novoLink;
            btnReabrir.disabled = false;
            
            // Captura os dados do link gerado
            const dados = extrairDadosDoLink(novoLink);

            // Salva no hist√≥rico com ID e Nickname
            saveHistory({
                linkCompleto: novoLink,
                linkCurto: dados.linkCurto, // Mantido por consist√™ncia, mas o Nickname √© o destaque agora
                id: dados.id,
                nickname: dados.nickname,
                date: getCurrentDateTime(),
                type: 'GERAR'
            });

            window.open(novoLink, '_blank');
        }
        
        function salvarAntecipar() {
            const linkAntecipar = document.getElementById('linkAntecipar').value.trim();
            
            if (!validarLink(linkAntecipar, 'avisoErroAntecipar', '?')) return;
            
            // Captura os dados do link antecipado
            const dados = extrairDadosDoLink(linkAntecipar);
            
            // Salva no hist√≥rico com ID e Nickname
            saveHistory({
                linkCompleto: linkAntecipar,
                linkCurto: dados.linkCurto,
                id: dados.id,
                nickname: dados.nickname,
                date: getCurrentDateTime(),
                type: 'ANTECIPAR'
            });
            
            alert(`Link de ${dados.nickname} salvo como Pendente no Hist√≥rico!`);
            
            document.getElementById('linkAntecipar').value = ''; 
        }
        
        function reabrirLink() {
            const linkResultado = document.getElementById('linkResultado').value;
            
            if (linkResultado && (linkResultado.startsWith(LINK_BASE_NOVO) || linkResultado.startsWith(LINK_BASE_ANTIGO))) {
                 window.open(linkResultado, '_blank');
            }
        }
        
        function resgateAntigo() {
            const linkAccessAntigo = document.getElementById('linkAccessAntigo').value.trim();
            
            if (!validarLink(linkAccessAntigo, 'avisoErroAntigo', 'access_token=')) return;
            
            let stringDeConsulta;
            if (linkAccessAntigo.includes('?')) {
                stringDeConsulta = linkAccessAntigo.substring(linkAccessAntigo.indexOf('?') + 1);
            } else if (linkAccessAntigo.startsWith('access_token=')) {
                stringDeConsulta = linkAccessAntigo;
            } else {
                document.getElementById('avisoErroAntigo').style.display = 'block';
                return;
            }

            const novoLink = LINK_BASE_ANTIGO + stringDeConsulta;
            
            // Captura os dados do link antigo
            const dados = extrairDadosDoLink(novoLink);

            // Salva no hist√≥rico com ID e Nickname
            saveHistory({
                linkCompleto: novoLink,
                linkCurto: dados.linkCurto,
                id: dados.id,
                nickname: dados.nickname,
                date: getCurrentDateTime(),
                type: 'ANTIGO'
            });

            window.open(novoLink, '_blank');
        }
        
        // Fun√ß√£o para Testar C√≥digo (Simplificada)
        function testarCodigo() {
            // Abre diretamente o link FIXO para teste
            window.open(LINK_TESTE_FIXO, '_blank');
        }


        document.addEventListener('DOMContentLoaded', () => {
            loadTheme();
            checkLoginStatus(); 
        });

    </script>
</body>
</html>