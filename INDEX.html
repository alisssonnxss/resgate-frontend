<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SISTEMA DE RESGATE DE C√ìDIGO √öNICO</title>
    <style>
        :root {
            /* Cores Dark Mode (Padr√£o) */
            --cor-primaria: #00BFFF; /* Azul Claro Vibrante */
            --cor-secundaria: #008DBC; /* Azul Mais Escuro */
            --cor-fundo: #121212; /* Fundo Escuro S√≥lido */
            --cor-card-fundo: #1E1E1E; /* Card Escuro */
            --cor-texto-principal: #F0F0F0;
            --cor-texto-secundario: #A0A0A0;
            --cor-aviso-erro: #FF5252;
            --cor-verde: #00E676;
            --cor-amarelo-pendente: #FFD700;
            --cor-borda: #333333;
            --cor-input-fundo: #2A2A2A; 
            --cor-hr: #3A3A3A;
            --cor-hover-item: #252525;
            
            --cor-btn-principal: var(--cor-primaria);
            --cor-btn-reabrir: var(--cor-verde);
            --cor-btn-deletar: #D50000;
            
            --border-radius-main: 12px;
            --border-radius-small: 6px;

            /* Cores de Status para Hist√≥rico */
            --status-pendente-cor: var(--cor-amarelo-pendente);
            --status-concluido-cor: var(--cor-verde);
        }

        body.light-mode {
            /* Cores Light Mode */
            --cor-primaria: #1E90FF;
            --cor-secundaria: #1C86EE;
            --cor-fundo: #F0F2F5; 
            --cor-card-fundo: #FFFFFF; 
            --cor-texto-principal: #333333; 
            --cor-texto-secundario: #666666;
            --cor-aviso-erro: #D32F2F; 
            --cor-verde: #388E3C; 
            --cor-amarelo-pendente: #FFC107;
            --cor-borda: #DDDDDD;
            --cor-input-fundo: #F8F8F8; 
            --cor-hr: #EEEEEE;
            --cor-hover-item: #F5F5F5;
            
            --cor-btn-deletar: #D32F2F;

            /* Cores de Status para Hist√≥rico Light */
            --status-pendente-cor: #FFB300;
            --status-concluido-cor: #4CAF50;
        }

        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
            background-color: var(--cor-fundo);
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px 10px;
            color: var(--cor-texto-principal);
            transition: background-color 0.2s, color 0.2s;
            overflow-x: hidden;
        }

        /* ----------------------------------- */
        /* TELA DE LOGIN (OVERLAY) */
        /* ----------------------------------- */
        .login-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--cor-fundo); 
            z-index: 10000; 
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            transition: opacity 0.5s, visibility 0.5s;
        }
        .login-box {
            background-color: var(--cor-card-fundo);
            padding: 30px;
            border-radius: var(--border-radius-main);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
            max-width: 350px;
            width: 90%;
            text-align: center;
            border: 1px solid var(--cor-borda);
        }
        .login-box h2 {
            color: var(--cor-primaria);
            margin-bottom: 20px;
            font-size: 1.4em;
        }
        .login-box input {
            margin-bottom: 15px;
        }
        
        /* NOVO ESTILO: BOT√ÉO DE LOGIN MAIS BONITO */
        .login-box button {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: var(--border-radius-small);
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            letter-spacing: 0.5px;
            transition: background-color 0.2s, transform 0.1s, box-shadow 0.2s;
            color: white;
            background-color: var(--cor-primaria); /* Cor principal */
            box-shadow: 0 5px 20px rgba(0, 191, 255, 0.5); /* Sombra mais forte */
        }
        .login-box button:hover {
            background-color: var(--cor-secundaria);
            box-shadow: 0 8px 25px rgba(0, 191, 255, 0.7);
            transform: translateY(-3px); /* Efeito 3D sutil */
        }


        #msgLogin {
            color: var(--cor-aviso-erro);
            font-weight: bold;
            margin-top: 10px;
            display: none;
        }
        
        .content-hidden {
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.5s;
        }
        
        body.logged-in .content-hidden {
            opacity: 1;
            visibility: visible;
        }

        /* --- SIDEBAR E OUTROS ESTILOS (MANTIDOS) --- */
        #menu-toggle-btn {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1000;
            font-size: 24px;
            color: var(--cor-texto-principal);
            background: var(--cor-card-fundo);
            border: 1px solid var(--cor-borda);
            padding: 5px 10px;
            border-radius: var(--border-radius-small);
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        #menu-toggle-btn:hover {
             color: var(--cor-primaria);
             border-color: var(--cor-primaria);
             transform: scale(1.05);
        }

        body:not(.logged-in) #menu-toggle-btn {
             display: none;
        }

        .sidebar {
            height: 100%;
            width: 0; 
            position: fixed;
            z-index: 999;
            top: 0;
            left: 0;
            background-color: var(--cor-card-fundo);
            overflow-x: hidden;
            transition: 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94); 
            padding-top: 60px;
            box-shadow: 4px 0 20px rgba(0,0,0,0.6);
            border-right: 3px solid var(--cor-primaria);
        }
        
        .sidebar-item {
            padding: 15px 25px;
            text-decoration: none;
            font-size: 1.1em;
            color: var(--cor-texto-principal);
            display: flex; 
            align-items: center;
            gap: 10px;
            transition: 0.2s background-color, 0.2s color, 0.2s padding-left;
            cursor: pointer;
            font-weight: 600;
            border-bottom: 1px solid var(--cor-hr);
        }

        .sidebar-item:hover {
            background-color: var(--cor-hover-item);
            color: var(--cor-primaria);
            padding-left: 30px; 
        }
        .sidebar-item.active {
             background-color: var(--cor-hover-item);
             color: var(--cor-primaria);
             border-left: 5px solid var(--cor-primaria);
        }
        .sidebar .closebtn {
            position: absolute;
            top: 0;
            right: 25px;
            font-size: 36px;
            margin-left: 50px;
            text-decoration: none;
            color: var(--cor-texto-secundario);
            transition: color 0.15s;
        }
        .sidebar .closebtn:hover {
             color: var(--cor-aviso-erro);
        }
        
        .sidebar-item-theme {
            font-weight: bold;
            color: var(--status-pendente-cor); 
        }

        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            height: 100%;
            width: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 998;
            display: none;
        }

        .container {
            background-color: var(--cor-card-fundo); 
            padding: 25px;
            border-radius: var(--border-radius-main);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2); 
            width: 100%;
            max-width: 450px;
            border: 1px solid var(--cor-borda);
            position: relative;
            margin-bottom: 30px; 
            transition: background-color 0.2s, box-shadow 0.2s;
            margin-top: 50px;
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 3px solid var(--cor-primaria);
        }

        h1 {
            color: var(--cor-texto-principal);
            text-align: center;
            margin: 0;
            font-size: 1.6em;
            letter-spacing: 1px;
            text-transform: uppercase;
            font-weight: 700;
        }
        
        .tab-content { display: none; padding-top: 10px; }
        .tab-content.active { display: block; }

        textarea, input[type="text"], input[type="search"] {
            width: 100%;
            padding: 12px;
            margin-bottom: 20px;
            border: 1px solid var(--cor-borda);
            background-color: var(--cor-input-fundo);
            color: var(--cor-texto-principal);
            border-radius: var(--border-radius-small);
            box-sizing: border-box;
            font-size: 0.95em;
            transition: border-color 0.2s, background-color 0.2s, box-shadow 0.2s;
        }
        
        .container button:not(.delete-button, .status-button) {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: var(--border-radius-small);
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            letter-spacing: 0.5px;
            transition: background-color 0.2s, transform 0.1s, box-shadow 0.2s;
            color: white;
            background-color: var(--cor-btn-principal);
            box-shadow: 0 4px 15px rgba(0, 191, 255, 0.3);
        }
        
        .container button:hover:not(.delete-button, .status-button) {
            background-color: var(--cor-secundaria);
            box-shadow: 0 6px 18px rgba(0, 191, 255, 0.4);
            transform: translateY(-2px);
        }

        .reopen-button {
            background-color: var(--cor-btn-reabrir) !important;
            box-shadow: 0 4px 15px rgba(0, 230, 118, 0.3);
            transition: background-color 0.2s, transform 0.1s, box-shadow 0.2s;
        }
        .reopen-button:hover {
            background-color: #00CC66 !important;
            box-shadow: 0 6px 18px rgba(0, 230, 118, 0.4);
            transform: translateY(-2px);
        }
        
        .historico-lista {
            list-style: none;
            padding: 0;
            margin: 15px 0 30px 0;
        }
        .historico-titulo {
            border-bottom: 2px solid var(--cor-hr);
            padding-bottom: 8px;
            margin-top: 20px;
            color: var(--cor-texto-principal);
            font-size: 1.2em;
        }

        .historico-item-wrapper {
            display: flex;
            align-items: center;
            background-color: var(--cor-input-fundo); 
            border-radius: var(--border-radius-small);
            margin-bottom: 10px;
            padding: 8px 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            position: relative;
            transition: all 0.2s;
        }
        .historico-item-wrapper:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        
        .historico-item-wrapper[data-status="PENDING"] {
            border-left: 4px solid var(--status-pendente-cor);
        }
        .historico-item-wrapper[data-status="COMPLETED"] {
            border-left: 4px solid var(--status-concluido-cor);
        }

        .historico-item {
            flex-grow: 1;
            padding: 5px;
            cursor: pointer;
            background-color: transparent;
        }

        .item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }
        .item-nome {
            font-weight: 700;
            color: var(--cor-texto-principal);
            font-size: 1em;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            max-width: 60%;
        }
        .item-data {
            font-size: 0.75em;
            color: var(--cor-texto-secundario);
            font-style: italic;
        }
        .item-info span {
            font-size: 0.85em;
            color: var(--cor-texto-secundario);
            font-weight: 500;
        }
        
        .status-button {
            display: block;
            width: 100%;
            padding: 6px 10px;
            margin-top: 8px;
            font-size: 0.8em;
            border: none;
            border-radius: var(--border-radius-small);
            cursor: pointer;
            font-weight: 600;
            color: var(--cor-texto-principal);
            background-color: var(--cor-card-fundo); 
            transition: background-color 0.15s, transform 0.1s;
        }
        .status-button:hover {
            background-color: var(--cor-hover-item);
            transform: translateY(-1px);
        }
        
        .delete-button {
            background-color: transparent;
            color: var(--cor-btn-deletar);
            border: none;
            width: 30px;
            height: 30px;
            line-height: 1;
            font-size: 1.2em; 
            font-weight: bold;
            cursor: pointer;
            flex-shrink: 0;
            transition: all 0.15s; 
            border-radius: 50%;
        }
        .delete-button:hover {
            background-color: rgba(213, 0, 0, 0.1); 
            color: #FF1744; 
            transform: scale(1.1);
        }
    </style>
</head>
<body>
    
    <div id="loginOverlay" class="login-overlay">
        <div class="login-box">
            <h2>ACESSO AO SISTEMA DE RESGATE</h2>
            <p style="color: var(--cor-texto-secundario); margin-bottom: 20px;">Insira o c√≥digo de acesso √∫nico.</p>
            
            <input type="text" id="inputCodigoUnico" placeholder="Digite seu c√≥digo aqui..." autocomplete="off" maxlength="15">

            <button onclick="fazerLogin()">ACESSAR SISTEMA</button>

            <p id="msgLogin">C√≥digo inv√°lido, j√° usado ou expirado.</p>
        </div>
    </div>

    <button id="menu-toggle-btn" class="content-hidden" onclick="openSidebar()">‚ò∞</button>

    <div class="overlay" onclick="closeSidebar()"></div>

    <div id="mySidebar" class="sidebar">
        <a href="javascript:void(0)" class="closebtn" onclick="closeSidebar()">&times;</a>
        
        <a class="sidebar-item" id="nav-gerar" onclick="changeTab('gerar')">üÜï Novo Resgate</a>
        <a class="sidebar-item" id="nav-antecipar" onclick="changeTab('antecipar')">‚≠ê Salvar Pendente</a>
        <a class="sidebar-item" id="nav-resgateAntigo" onclick="changeTab('resgateAntigo')">üóùÔ∏è Resgate Antigo</a>
        
        <a class="sidebar-item sidebar-item-theme" id="nav-theme" onclick="toggleTheme(); closeSidebar();">
            <span id="sidebar-theme-text">‚òÄÔ∏è Mudar Tema</span>
        </a>

        <a class="sidebar-item" onclick="fazerLogout();">üö™ Sair (Usar Outro C√≥digo)</a>
    </div>

    <div class="container content-hidden">
        <div class="header-content">
            <h1>SISTEMA DE RESGATE DE C√ìDIGO √öNICO</h1>
        </div>

        <div id="gerar" class="tab-content active">
            <label for="linkOriginal">Cole o Link de Origem (Ex: help.garena.com?ref=...)</label>
            <textarea id="linkOriginal" placeholder="Cole o link de origem completo aqui..."></textarea>

            <button onclick="gerarLink()">Gerar e Abrir Link</button>

            <hr style="margin: 30px 0; border: 0; border-top: 1px solid var(--cor-hr);">

            <label for="linkResultado">Link de Resgate Gerado:</label>
            <input type="text" id="linkResultado" value="Aguardando..." readonly>

            <button class="reopen-button" onclick="reabrirLink()" id="btnReabrir" disabled style="margin-top: 10px;">
                ‚û°Ô∏è Reabrir Link Atual
            </button>
            
            <p class="aviso" id="avisoErroGerar" style="display:none; color: var(--cor-aviso-erro); margin-top: 10px;">
                üö® Por favor, cole um link v√°lido que contenha '?' (ponto de interroga√ß√£o).
            </p>
        </div>
        
        <div id="antecipar" class="tab-content">
            <label for="linkAntecipar">Cole o Link para Salvar como Pendente:</label>
            <textarea id="linkAntecipar" placeholder="Cole o link completo aqui. Ele ser√° salvo para resgatar depois."></textarea>

            <button onclick="salvarAntecipar()">Salvar como Pendente</button>

            <p class="aviso" id="avisoErroAntecipar" style="display:none; color: var(--cor-aviso-erro); margin-top: 10px;">
                üö® Por favor, cole um link v√°lido que contenha '?' (ponto de interroga√ß√£o).
            </p>
        </div>

        <div id="resgateAntigo" class="tab-content">
            <label for="linkAccessAntigo">Cole o Access Token/URL Inteira (Ex: access_token=...) </label>
            <textarea id="linkAccessAntigo" placeholder="Cole o access token completo ou a URL inteira aqui..."></textarea>

            <button onclick="resgateAntigo()">Resgatar com M√©todo Antigo</button>

            <p class="aviso" id="avisoErroAntigo" style="display:none; color: var(--cor-aviso-erro); margin-top: 10px;">
                üö® Por favor, cole um token v√°lido que contenha 'access_token=' ou '?'.
            </p>
        </div>
        
        </div>
    
    <div class="footer content-hidden">
        Sistema de Resgate de C√≥digo √önico
    </div>

    <script>
        // CR√çTICO: COLOQUE A URL DO SEU BACKEND AQUI AP√ìS O DEPLOY NO RENDER!
        const BACKEND_URL = "https://resgate-api-node.onrender.com"; 

        const LINK_BASE_NOVO = "https://reward.ff.garena.com/en?";
        const LINK_BASE_ANTIGO = "https://reward.ff.garena.com/";
        
        const STORAGE_KEY = 'resgateHistory';
        const THEME_KEY = 'siteTheme';
        const TOKEN_KEY = 'sessionTokenUnique'; 

        // --- FUN√á√ïES DE LOGIN (INTEGRA√á√ÉO COM O BACKEND) ---
        
        function liberarAcessoTotal() {
            document.body.classList.add('logged-in');
            document.getElementById('loginOverlay').style.display = 'none';
            changeTab('gerar'); 
        }

        async function fazerLogin() {
            const input = document.getElementById('inputCodigoUnico');
            const msg = document.getElementById('msgLogin');
            const codigoDigitado = input.value.trim();
            
            msg.style.display = 'none';

            if (!codigoDigitado) {
                msg.innerText = "‚ùå Digite o c√≥digo de acesso.";
                msg.style.display = 'block';
                return;
            }

            try {
                // Envia o c√≥digo para o Backend (Render)
                const response = await fetch(`${BACKEND_URL}/api/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code: codigoDigitado })
                });

                const data = await response.json();

                if (response.ok) {
                    // SUCESSO! O Backend invalidou o c√≥digo e retornou um token.
                    localStorage.setItem(TOKEN_KEY, data.sessionToken); 
                    liberarAcessoTotal();
                } else {
                    // FALHA: C√≥digo inv√°lido, j√° usado ou erro do servidor.
                    msg.innerText = data.message || 'Erro de login. Tente novamente.';
                    msg.style.display = 'block';
                }
            } catch (error) {
                console.error('Erro de conex√£o com o Backend:', error);
                msg.innerText = '‚ùå Erro de conex√£o. Servidor indispon√≠vel ou URL errada.';
                msg.style.display = 'block';
            }
        }
        
        function fazerLogout() {
            localStorage.removeItem(TOKEN_KEY);
            document.body.classList.remove('logged-in');
            document.getElementById('loginOverlay').style.display = 'flex';
        }
        
        function checkLoginStatus() {
            const token = localStorage.getItem(TOKEN_KEY);
            
            if (token) {
                liberarAcessoTotal();
            } else {
                document.getElementById('loginOverlay').style.display = 'flex';
            }
        }

        // --- FUN√á√ïES DE SIDEBAR E NAVEGA√á√ÉO ---
        function openSidebar() {
            document.getElementById("mySidebar").style.width = "250px";
            document.querySelector(".overlay").style.display = "block";
        }

        function closeSidebar() {
            document.getElementById("mySidebar").style.width = "0";
            document.querySelector(".overlay").style.display = "none";
        }
        
        function changeTab(tabName) {
            closeSidebar(); 
            
            let tabcontent = document.getElementsByClassName("tab-content");
            for (let i = 0; i < tabcontent.length; i++) {
                tabcontent[i].classList.remove("active");
            }
            
            document.getElementById(tabName).classList.add("active");
            
            document.querySelectorAll('.sidebar-item').forEach(item => item.classList.remove('active'));
            document.getElementById(`nav-${tabName}`).classList.add('active');
        }
        
        // --- FUN√á√ïES DE TEMA ---
        function applyTheme(isLight) {
            const body = document.body;
            const toggleSidebar = document.getElementById('sidebar-theme-text');
            
            if (isLight) {
                body.classList.add('light-mode');
                toggleSidebar.innerHTML = 'üåô Mudar para Modo Escuro';
                localStorage.setItem(THEME_KEY, 'light');
            } else {
                body.classList.remove('light-mode');
                toggleSidebar.innerHTML = '‚òÄÔ∏è Mudar para Modo Claro';
                localStorage.setItem(THEME_KEY, 'dark');
            }
        }
        function toggleTheme() {
            const isLight = document.body.classList.contains('light-mode');
            applyTheme(!isLight);
        }
        function loadTheme() {
            const savedTheme = localStorage.getItem(THEME_KEY) || 'dark';
            applyTheme(savedTheme === 'light');
        }
        
        // --- GERA√á√ÉO E OUTROS ---
        
        function validarLink(link, avisoId, deveConter = '?') {
            const avisoErro = document.getElementById(avisoId);
            const isValid = link.includes(deveConter);
            
            if (!isValid) {
                avisoErro.style.display = 'block';
                return false; 
            }

            avisoErro.style.display = 'none';
            return true;
        }

        function gerarLink() {
            const linkOriginal = document.getElementById('linkOriginal').value.trim();
            const linkResultadoInput = document.getElementById('linkResultado');
            const btnReabrir = document.getElementById('btnReabrir');
            
            btnReabrir.disabled = true;
            linkResultadoInput.value = "Aguardando...";

            if (!validarLink(linkOriginal, 'avisoErroGerar', '?')) return;

            const stringDeConsulta = linkOriginal.substring(linkOriginal.indexOf('?') + 1);
            const novoLink = LINK_BASE_NOVO + stringDeConsulta;
            
            linkResultadoInput.value = novoLink;
            btnReabrir.disabled = false;

            window.open(novoLink, '_blank');
        }
        
        function salvarAntecipar() {
             const linkAntecipar = document.getElementById('linkAntecipar').value.trim();
            
            if (!validarLink(linkAntecipar, 'avisoErroAntecipar', '?')) return;
            
            alert("Link salvo com sucesso (localmente)! Voc√™ pode copi√°-lo quando precisar.");
            
            document.getElementById('linkAntecipar').value = ''; 
        }
        
        function reabrirLink() {
            const linkResultado = document.getElementById('linkResultado').value;
            
            if (linkResultado && (linkResultado.startsWith(LINK_BASE_NOVO) || linkResultado.startsWith(LINK_BASE_ANTIGO))) {
                 window.open(linkResultado, '_blank');
            }
        }
        
        function resgateAntigo() {
            const linkAccessAntigo = document.getElementById('linkAccessAntigo').value.trim();
            
            if (!validarLink(linkAccessAntigo, 'avisoErroAntigo', 'access_token=')) return;
            
            let stringDeConsulta;
            if (linkAccessAntigo.includes('?')) {
                stringDeConsulta = linkAccessAntigo.substring(linkAccessAntigo.indexOf('?') + 1);
            } else if (linkAccessAntigo.startsWith('access_token=')) {
                stringDeConsulta = linkAccessAntigo;
            } else {
                document.getElementById('avisoErroAntigo').style.display = 'block';
                return;
            }

            const novoLink = LINK_BASE_ANTIGO + stringDeConsulta;
            
            window.open(novoLink, '_blank');
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadTheme();
            checkLoginStatus(); 
        });

    </script>
</body>
</html>